<!DOCTYPE html>
<html lang="en">
<head>
	<head th:replace="head"></head>
	<title>财务报表明细</title>
	<link rel="stylesheet" href="assets/js/select2/select2.css"/>
	<link rel="stylesheet" href="assets/js/select2/select2-bootstrap.css"/>
	<link rel="stylesheet" href="assets/css/jquery.datetimepicker.min.css"/>
	<script src="https://unpkg.com/qiniu-js@2.5.3/dist/qiniu.min.js"></script>
	<style type="text/css">
	.form-group img{
		max-width:400px;
		max-height:300px;
	}
	</style>
</head>
<body class="page-body">

	<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
			
		<div th:replace="sidebar-menu"></div>
		<div class="main-content">
			<!-- User Info, Notifications and activity Bar -->
			<nav th:replace="navbar"></nav>
			<div class="page-title">
				<div class="title-env">
					<h1 class="title">财务报表明细</h1>
					<p class="activityDescription"></p>
				</div>
				<div class="breadcrumb-env">
					<ol class="breadcrumb bc-1">
						<li><a href="/"><i class="fa-home"></i>Home</a></li>
						<li><a>系统管理</a></li>
						<li class="active"><strong>财务报表明细</strong></li>
					</ol>
				</div>
			</div>
			
			<div class="panel panel-default">
				<div class="panel-heading">
					<form role="form" class="form-inline" id="queryForm">
						<div class="input-group">
							<label for="sTime" class="control-label">开始时间</label>
							<input type="text" class="form-control" name="sTime" id="sTime" style="height:35px"
								   placeholder="开始时间"/>
						</div>
						<div class="input-group">
							<label for="eTime" class="control-label">结束时间</label>
							<input type="text" class="form-control" name="eTime" id="eTime" style="height:35px"
								   placeholder="结束时间"/>
						</div>
						<div class="input-group">
							<label for="orderStatus" class="control-label">订单状态</label>
							<select id="orderStatus" name="orderStatus" class="form-control" style="height:35px">
								<option value="" selected="selected">全部</option>
								<option value="0">审核中</option>
								<option value="1">待退货</option>
								<option value="2">退货中</option>
								<option value="3">退款中</option>
								<option value="4">退款成功</option>
								<option value="5">退款取消</option>
								<option value="6">审核失败</option>
							</select>
						</div>
						<div class="input-group">
							<label for="status" class="control-label">结算状态</label>
							<select id="status" name="status" class="form-control" style="height:35px">
								<option value="" selected="selected">全部</option>
								<option value="0">待结算</option>
								<option value="1">结算中</option>
								<option value="2">已结算</option>
							</select>
						</div>
						<div class="input-group">
							<label for="payChannel" class="control-label">支付渠道</label>
							<select id="payChannel" name="payChannel" class="form-control" style="height:35px">
								<option value="" selected="selected">全部</option>
								<option value="wxpay">微信支付</option>
								<option value="alipay">支付宝</option>
							</select>
						</div>
						<div class="form-group" style="margin-left: 0;margin-right:5px;margin-top:5px;display: block;">
							<button class="btn btn-secondary btn-single searchBtn" style="height:35px">查询</button>
							<button class="btn btn-secondary btn-single returnBtn" style="height:35px" onclick="return goBack()">返回财务报表</button>
						</div>
					</form>
				</div>
				<div class="panel-body">
					<table id="example-1" class="table table-striped table-bordered" cellspacing="0" width="100%">
					</table>
					
				</div>
				<button class="btn btn-info settle" >结算</button>
				<button class="btn btn-info export">导出</button>
<!--				<button class="btn btn-info del">删除</button>-->
			</div>
			
					
			<footer th:replace="footer"></footer>
		</div>
	</div>
	
	<div th:replace="body-under"></div>
	
	<div class="modal fade in" id="modal-6">
		<div class="modal-dialog">
			<div class="modal-content" style="width: 800px;">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h4 class="modal-title"></h4>
				</div>
				
				<div class="modal-body">
					<form role="form" id="saveForm">
					<input type="hidden" name="id"/>
					</form>
				</div>
				
				<div class="modal-footer">
					<button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
					<button type="button" class="btn btn-info save">保存</button>
					<button type="button" class="btn btn-white bg-lg" style="display:none">数据提交中，请稍等....</button>
				</div>
				
			</div>
		</div>
	</div>
    <div class="modal fade in" id="preview" aria-hidden="false" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">查看详情</h4>
                </div>

                <div class="modal-body" id="preview_body"></div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

	<script src="js/common.js"></script>
	<script src="assets/js/moment.min.js"></script>
	<script src="assets/js/select2/select2.min.js"></script>
	<script src="assets/js/jquery.datetimepicker.full.min.js"></script>
	<script src="assets/js/async.min.js"></script>
	<script th:inline="javascript">
	/*<![CDATA[*/

	function goBack() {
		window.location.href = '/settle.html';
		return false;
	}

	function closeIt(self) {
		var that = $(self);
		that.hide();
	}

    function formatTime(time) {
        return new Date(time).Format("yyyy-MM-dd hh:mm:ss");
    }

    function buildImg(url) {
        return "<img width='100px' height='100px' src='#' />".replace("#", url);
    }

    function appendToPreview(key, value) {
        return '<div class="row">' +
            '<div class="col-md-2">' +
            key +
            '</div>' +
            '<div class="col-md-10">' +
            value +
            '</div>' +
            '</div>';
    }

    function checkIt(id) {
		alert("暂不支持");
		return;
        $.post("/goodsType_find", {"id": id}, function (data) {
            if (data) {
                var preview = $("#preview_body");
                var contentStr = "";
                var mainObj = data["main"];
                contentStr += appendToPreview("编号:", mainObj["id"]);
                contentStr += appendToPreview("名称:", mainObj["name"]);
                contentStr += appendToPreview("图片:", buildImg(mainObj["image"]));
                contentStr += appendToPreview("创建时间:", formatTime(mainObj["createTime"]));
                contentStr += appendToPreview("备注:", mainObj["remark"]);

                for (var category in data["categoryList"]) {
                    category = data["categoryList"][category];
                    contentStr += appendToPreview("商品类别ID:", category["goodsType"]);
                    contentStr += appendToPreview("商品类别名称:", category["goodsTypeName"]);
                    contentStr += appendToPreview("创建时间:", formatTime(category["createTime"]));
                    contentStr += appendToPreview("图片:", buildImg(category["image"]));
                    contentStr += appendToPreview("名称:", category["name"]);
                    contentStr += appendToPreview("编号:", category["id"]);
                    contentStr += appendToPreview("备注:", category["remark"]);
                    contentStr += appendToPreview("排序:", category["sort"]);
                }
                preview.html(contentStr);
                jQuery('#preview').modal('show', {backdrop: 'fade'});
                toastr.success("操作已成功！", "温馨提示");
            } else {
                toastr.error("操作失败", "温馨提示");
            }
        });
    }

	function calcAmount(id) {
		$.post("/settle_inner_calc", {"ids": [id]}, function (data) {
			if (data) {
				toastr.success("操作已成功！", "温馨提示");
				table_global.fnDraw(); //or fnReloadAjax()
			} else {
				toastr.error("操作失败", "温馨提示");
			}
		});
	}

	function settleOrder(id) {
		$.post("/settle_inner_settle", {"ids": [id]}, function (data) {
			if (data) {
				toastr.success("操作已成功！", "温馨提示");
				table_global.fnDraw(); //or fnReloadAjax()
			} else {
				toastr.error("操作失败", "温馨提示");
			}
		});
	}

	var table_global;
	var qiniuUrl = [[${qiniuUrl}]];
	var theId = [[${theId}]];

    jQuery(document).ready(function($)
	{
		jQuery.datetimepicker.setLocale('zh');
		jQuery('#sTime').datetimepicker(
				{
					"lang": "zh",
					"format": "Y-m-d H:i:s",
					"timepicker": true,
					"datepicker": true,
					"defaultDate": new Date(),
					"defaultTime": "00:00:00"
				}
		);
		jQuery('#eTime').datetimepicker(
				{
					"lang": "zh",
					"format": "Y-m-d H:i:s",
					"timepicker": true,
					"datepicker": true,
					"defaultDate": new Date(),
					"defaultTime": "00:00:00"
				}
		);

		var oTable = $("#example-1").dataTable({
			language: {
                url: "../assets/Chinese.txt"
            },
			bFilter : false,
			bServerSide : true,//服务器处理分页，默认是false，需要服务器处理，必须true
            sAjaxDataProp : "aData",//是服务器分页的标志，必须有   
            sAjaxSource : "/settle_inner_list",//通过ajax实现分页的url路径。
            fnServerParams : function(aData){
				var searchArray = $(".form-inline").serializeArray();
				$.merge(aData, searchArray);
				aData.push({"name": "theId", "value": theId});//append pid
			},
			columnDefs: [
				{
					targets: 0,
					data: "id",
					width: "5%",
					orderable: false,
					className: 'select-checkbox',
					title: '<input type="checkbox" id="checkbox-all"/>',
					render: function (data, type, full, meta) {
						return '<input type="checkbox" name="activityId" value="' + data + '" />';
					}
				},
				{
					targets: 1,
					data: "id",
					title: "序号"
				},
				{
					targets: 2,
					data: "orderNo",
					title: "订单号"
				},
				{
					targets: 3,
					data: "goods",
					title: "商品名称",
					render: function (data, type, full, meta) {
						var str = "";
						var refundMap = {};
						for (var i in data) {
							var it = data[i];
							if (refundMap.hasOwnProperty(it["goodsId"])) {
								str += "<p style='color: red'>" + it["goodsName"] + "&nbsp;" + it["remark"] + "&nbsp;" + it["goodsCount"] + "件</p>";
							} else {
								str += "<p>" + it["goodsName"] + "&nbsp;" + it["remark"] + "&nbsp;" + it["goodsCount"] + "件</p>";
							}
						}
						return str;
					}
				},
				{
					targets: 4,
					data: "price",
					title: "订单总价"
				},
				{
					targets: 5,
					data: "amount",
					title: "实付金额"
				},
				{
					targets: 6,
					data: "mvoucherAmount",
					title: "店铺优惠券金额"
				},
				// {
				// 	targets: 6,
				// 	data: "pvoucherAmount",
				// 	title: "平台优惠券金额"
				// },
				// {
				// 	targets: 7,
				// 	data: "walletAmount",
				// 	title: "钱包金额"
				// },
				{
					targets: 7,
					data: "mailFee",
					title: "运费"
				},
				{
					targets: 8,
					data: "payChannel",
					title: "支付渠道",
					render: function (data, type, row, meta) {
						//支付渠道[wxpay,alipay]
						var map = {"wxpay": "微信支付", "alipay": "支付宝"};
						return map.hasOwnProperty(data) ? map[data] : "未知";
					}
				},
				// {
				// 	targets: 10,
				// 	data: "payFee",
				// 	title: "支付渠道手续费"
				// },
				{
					targets: 9,
					data: "cutRate",
					title: "抽成比率"
				},
				{
					targets: 10,
					data: "cutAmount",
					title: "抽成金额"
				},

				{
					targets: 11,
					data: "settledAmount",
					title: "结算金额"
				},
				{
					targets: 12,
					data: "remark",
					title: "订单状态",
					render: function (data, type, row, meta) {
						//状态[0-已下单,1-已付款,2-已发货,3-已收货,4-取消] **/
						var map = ["已下单", "已付款", "已发货", "已收货", "取消"];
						return map.hasOwnProperty(parseInt(data)) ? map[parseInt(data)] : "未知";
					}
				},
				{
					targets: 13,
					data: "status",
					title: "结算状态",
					render: function (data, type, row, meta) {
						/** 状态[0-待结算,1-结算中,2-已结算] **/
						var map = ["待结算", "结算中", "已结算"];
						return map.hasOwnProperty(parseInt(data)) ? map[parseInt(data)] : "未知";
					}
				},
				// {
				// 	targets: 15,
				// 	data: "settledName",
				// 	title: "结算人"
				// },
				{
					targets: 14,
					data: "createTime",
					title: "创建时间",
					render: function (data, type, row, meta) {
						return new Date(data).Format("yyyy-MM-dd hh:mm:ss");
					}
				},
				{
					targets: 15,
					data: "settledTime",
					title: "结算时间",
					render: function (data, type, row, meta) {
						return new Date(data).Format("yyyy-MM-dd hh:mm:ss");
					}
				},
				{
					targets: 16,
					data: "id",
					orderable: false,
					title: "操作",
					render: function (data, type, full, meta) {
						return '<input type="button" name="checkIt" onclick="checkIt(' + data + ')" value="查看详情"/>';
					}
				},
				{
					targets: 17,
					data: "id",
					orderable: false,
					title: "操作",
					render: function (data, type, full, meta) {
						switch (parseInt(full["status"])) {
							case 0:
								return '<input type="button" name="checkIt" onclick="calcAmount(' + data + ')" value="结算金额"/>';
							case 1:
								return '<input type="button" name="checkIt" onclick="settleOrder(' + data + ')" value="确认结算"/>';
							case 2:
								return '<input type="button" name="checkIt" disabled="disabled" value="已结算"/>';
						}
					}
				}
			]
		});

		table_global = oTable;
		
		$(".searchBtn").click(function(){
			$("#checkbox-all").attr("checked", false);
			oTable.fnDraw(); //or fnReloadAjax()  
			return false;
		});

		$(".btn.btn-info.export").click(function () {
			var activityId = $("input[name='activityId']:checked");
			if (activityId.length < 1) {
				toastr.error("请至少选择一条数据操作", "温馨提示");
				return;
			}

			var ids = [];
			activityId.each(function (i, e) {
				ids.push(e.value);
			});

			window.open('/settle_inner_export.html?ids[]=' + ids, "_blank");
			return false;
		});

		$(".btn.btn-info.settle").click(function () {
			var activityId = $("input[name='activityId']:checked");
			if (activityId.length < 1) {
				toastr.error("请至少选择一条数据操作", "温馨提示");
				return;
			}

			var ids = [];
			activityId.each(function (i, e) {
				ids.push(e.value);
			});

			$.post("/settle_inner_batchSettle", {"ids": ids}, function (data) {
				if (data) {
					toastr.success("操作已成功！", "温馨提示");
					oTable.fnDraw();
					alert("你需要结算给商户" + data + "元");
				}
			});
		});
	});
	/*]]>*/
	</script>
</body>

</html>
